# Get all needed packages:
apt update
apt upgrade
apt install build-essential u-boot-tools libncurses5-dev git bison flex bc libssl-dev
# NOTE: If compiled on the WD device, the Cross-compiler can be skipped. If on different device the following command needs to be run
apt install crossbuild-essential-armhf

# Get sources of Linux Kernel version 5.5.3 to compile:
git clone --depth 1 --branch v5.5.3 git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git linux-stable

# Copy prepared config file to linux directory
cp kernel.config linux-stable/.config

# Copy prepared Device Tree for WD MyCloud Ex2 Ultra
cp armada-385-wdmc-Ex2-Ultra.dts linux-stable/arch/arm/boot/dts/

# Пора начинать...
# Примечание: Если сборка ведется непосредственно на устройстве, то пропускаем строки с установкой переменных ARCH и CROSS_COMPILE
# Примечание: $DIR_RESULT - Путь, куда будет сохранен результат (Ядро и модули)
# Примечание: Опция "-j 4" указывает на то, сколько ядер процессора будут задействованны в сборке. Уберите для авто-выбора или замените на своё значение.
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
export DIR_RESULT=../output
export DTS_FILE=armada-385-wdmc-Ex2-Ultra
mkdir -p $DIR_RESULT
cd linux-stable

#make -j 4 oldconfig
#make -j 4 menuconfig

# Собственно, собираем все:
make -j 4 zImage
make -j 4 $DTS_FILE.dtb
make -j 4 modules
make -j 4 INSTALL_MOD_PATH=$DIR_RESULT modules_install
cp arch/arm/boot/zImage zImage_and_dtb
cat arch/arm/boot/dts/$DTS_FILE.dtb >> zImage_and_dtb
mkimage -A arm -O linux -T kernel -C none -a 0x00008000 -e 0x00008000 -n $DTS_FILE -d zImage_and_dtb $DIR_RESULT/uImage
rm zImage_and_dtb

# The new Kernel v5.5.3 will not load at standard memory addresses. We need to flash new custom u-boot

Thank you to 
To build your uboot, download the GPL Software from WD Website, e.g. here
https://downloads.wdc.com/gpl/WDMyCloud_Ex2Ultra_GPL_v2.31.204_20191206.tar.gz

Extract WDMyCloud_Ex2Ultra_GPL_v2.31.204_20191206.tar.gz
You need 2 folders "u-boot" and "toolchain"
Go to "u-boot" and extract "u-boot-2013.01-2014_T3.0p2.tar.gz"
Go to "toolchain" and extract "armv7-marvell-linux-gnueabi-softfp_i686_64K_Dev_20131002.tar.gz"
Change variable PATH in u-boot/u-boot-2013.01-2014_T3.0p2/xbuid.sh to correct path of "armv7-marvell-linux-gnueabi-softfp_i686_64K_Dev_20131002/bin"
For x64: sudo apt install gcc-multilib
cp GrandTeton-20170708.patch u-boot/u-boot-2013.01-2014_T3.0p2
cd u-boot/u-boot-2013.01-2014_T3.0p2
patch -p1 < GrandTeton-20170708.patch
sudo ./xbuid.sh build
Or use dtd (https://forum.doozan.com/profile.php?2,4429) patched u-boot for my EX2 Ultra at the attachment.

For full details see the post of CyberPK at
https://forum.doozan.com/read.php?2,28939,98649#msg-98649. All credits goes to him.


usb start
bubt u-boot.bin nand usb
reset

setenv bootcmd 'nand read.e 0x02000020 0x0500000 0x0500000; nand read.e 0x2900000 0x0a00000 0x0500000; bootm 0x02000020 0x2900000'
saveenv

