# Get all needed packages:
apt update
apt upgrade
apt install build-essential u-boot-tools libncurses5-dev git bison flex bc libssl-dev
# NOTE: If compiled on the WD device, the Cross-compiler can be skipped. If on different device the following command needs to be run
apt install crossbuild-essential-armhf

# Get sources of Linux Kernel version 5.5.3 to compile:
git clone --depth 1 --branch v5.5.3 git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git linux-stable

# Copy prepared config file to linux directory
cp kernel.config linux-stable/.config

# Copy prepared Device Tree for WD MyCloud Ex2 Ultra
cp armada-385-wdmc-Ex2-Ultra.dts linux-stable/arch/arm/boot/dts/

# Пора начинать...
# Примечание: Если сборка ведется непосредственно на устройстве, то пропускаем строки с установкой переменных ARCH и CROSS_COMPILE
# Примечание: $DIR_RESULT - Путь, куда будет сохранен результат (Ядро и модули)
# Примечание: Опция "-j 4" указывает на то, сколько ядер процессора будут задействованны в сборке. Уберите для авто-выбора или замените на своё значение.
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
export DIR_RESULT=../output
export DTS_FILE=armada-385-wdmc-Ex2-Ultra
mkdir -p $DIR_RESULT
cd linux-stable

#make -j 4 oldconfig
#make -j 4 menuconfig

# Собственно, собираем все:
make -j 4 zImage
make -j 4 $DTS_FILE.dtb
make -j 4 modules
make -j 4 INSTALL_MOD_PATH=$DIR_RESULT modules_install
cat arch/arm/boot/zImage arch/arm/boot/dts/$DTS_FILE.dtb > zImage_and_dtb
mkimage -A arm -O linux -T kernel -C none -a 0x00008000 -e 0x00008000 -n $DTS_FILE -d zImage_and_dtb $DIR_RESULT/uImage
rm zImage_and_dtb

# Готово! Результат будет в папке $DIR_RESULT ("output" по умолчанию)
